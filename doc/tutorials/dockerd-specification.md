# How to Write a Specification in Elektra for dockerd

## Overview

### Introduction

In this tutorial you will learn how to interactively use the `SpecElektra` specification
language and `kdb` to write a configuration specification for [dockerd](https://docs.docker.com/engine/reference/commandline/dockerd/).

### What you should already know

- Already know how to write a [specification](specification.md)

### What youâ€™ll learn

- how to create and mount a specification using `kdb`
- how to add keys with different types, defaults, enums, array specifications, wildcard specifications and examples to your specification and how to validate them

### What you'll do

- use `kdb` to create and mount a specification for [dockerd](https://docs.docker.com/engine/reference/commandline/dockerd/)
- define defaults, array / wildcard specifications, examples and checks for keys in the validation
- use the specification as a starting point for customizing the configuration of installed applications

### Scope

In this tutorial we will introduce a possible specification for [dockerd](https://docs.docker.com/engine/reference/commandline/dockerd/).
Using `kdb` we will configure the specification.

> NOTE: As the specification for dockerd is quite big we will only present a sample for the above mentioned metakeys and link to a full specification [dockerd-full-spec](../../examples/spec/dockerd.ini).

## Getting Started

Before we start just an overview of the structure:

- Specification file location: `/etc/dockerd/dockerd-daemon.ni`
- Parent specification key: `spec:/sw/dockerd`

## Mount Setup

### Step 1: Mount dockerd specification

First you need to mount a specification file, in this case `docker.ni` to the `spec:/` namespace.
You can define the path inside the `spec:/` namespace as `/sw/dockerd`, refer to
[the documentation](https://www.libelektra.org/tutorials/integration-of-your-c-application) to find out more about constructing the name.

```sh
sudo kdb mount /etc/dockerd/dockerd-daemon.ni spec:/sw/dockerd ni
```

> Note: ni is the format which is used for the specification in the file.
> You can also choose to use json, then you need use yajl instead of ni.

### Step 2: Define a mountpoint

Next you can define, that this specification uses a specific mountpoint for a concrete application configuration.
So you can say the concrete configuration should be written to `daemon.ni`.

```sh
kdb meta-set spec:/sw/dockerd mountpoint daemon.ni
```

Your `spec.ni` file should now look something like this:

```sh
cat $(kdb file spec:/sw/dockerd)

# ;Ni1
# ; Generated by the ni plugin using Elektra (see libelektra.org).

# =

# []
#  meta:/mountpoint = daemon.ni
```

### Step 3: Do a specification mount

```sh
sudo kdb spec-mount /tests/sw/org/app/\#0/current ni
```

This specification mount makes sure that the paths where the concrete configuration should be (`daemon.ni`)
are ready to fulfill our specification (`dockerd-daemon.ni`).
Be aware that different files get mounted for different namespaces.
You've a specification file (`dockerd-daemon.ni`) for the `spec`-namespace and three files (`daemon.ni`) on different locations
for the `dir`- `user`- and `system`-namespaces.

You can see the files by providing the namespace as prefix to the `kdb file` command:

```sh
kdb file system:/sw/dockerd
# /etc/kdb/daemon.ni

kdb file user:/sw/dockerd
# /home/user/.config/daemon.ni

kdb file dir:/sw/dockerd
# /current/working/directory/.dir/daemon.ni
```

> **_Note_**: The files only exist, when configuration values are stored there,
> i.e. they are created on the first `kdb set` and removed with the last `kdb rm`.

For more information about namespaces in Elektra please see [here](https://www.libelektra.org/man-pages/elektra-namespaces),
a tutorial about the topic is available [here](https://www.libelektra.org/tutorials/namespaces).

## Writing specification for keys

In this example for `dockerd` we will be using 3 types of specifications:

- Simple specification (type and description)
- Enum specifications (for keys were only a set of possible options can be used)
- Array and wildcard specifications (for keys where a list of possible options can be used)

As the `dockerd` specification is big we will just present one of each of the above mentioned specification types.

> NOTE: In Elektra we use `/` instead of `-` to seperate key names.
> This results in a hierarchical structure of key names.
> This commands will automatically store the specification in the `dockerd-daemon.ni` specification file.

### Array specification

```ini
[data/root]
meta:/type = string
meta:/description = Root directory of persistent Docker state
meta:/default = /var/lib/docker
```

In order to get the above specification we will need the following commands:

```sh
kdb meta-set spec:/sw/dockerd/data/root type string

kdb meta-set spec:/sw/dockerd/data/root description "Root directory of persistent Docker state"

kdb meta-set spec:/sw/dockerd/data/root default "/var/lib/docker"
```

In case no `data/root` key gets configured the value `/var/lib/docker` is used.

### Enum specification (for keys were only a set of possible options can be used)

```ini
[default/cgroupns/mode]
meta:/description = Default mode for containers cgroup namespace
meta:/default = private
meta:/check/enum = #1
meta:/check/enum/#0 = host
meta:/check/enum/#1 = private
```

In order to get the above specification we will need the following commands:

```sh
kdb meta-set spec:/sw/dockerd/default/cgroupns/mode description "Default mode for containers cgroup namespace"

kdb meta-set spec:/sw/dockerd/default/cgroupns/mode default "private"

kdb meta-set spec:/sw/dockerd/default/cgroupns/mode check/enum "#1"

kdb meta-set spec:/sw/dockerd/default/cgroupns/mode check/enum/#0 "host"

kdb meta-set spec:/sw/dockerd/default/cgroupns/mode check/enum/#1 "private"
```

With this configuration we have managed to allow two possible values for `default/cgroupns/mode`.
The values are `host` and `private`.
The default value if we do not set any configuration is `private`.

### Wildcard specifications (for keys where a list of possible options can be used)

```ini
[default/ulimits/_]
meta:/type = string
meta:/description = Default ulimits for containers
meta:/example = 64000
```

For this specification we want to allow an arbitrary number of `default ulimits`.
The name of the `ulimits` does not matter but all should have the same metakeys.

In order to get the above specification we will need following commands:

```sh
kdb meta-set spec:/sw/dockerd/default/ulimits/_ type string

kdb meta-set spec:/sw/dockerd/default/ulimits/_ description "Default ulimits for containers"

kdb meta-set spec:/sw/dockerd/default/ulimits/_ example "64000"
```

The above specification will allow us to create any name below the `default/ulimits` key.
The value needs to be a string.
The sample value is `64000`.

### Array specifications (for keys where a list of possible options can be used)

```ini
[default/address/pools]
meta:/array/min = 0
meta:/description = Default address pools for node specific local networks (list)

[default/address/pools/#/base]
meta:/type = string
meta:/description = Ip address (ipv4) + subnet
meta:/example = 172.30.0.0/16

[default/address/pools/#/size]
meta:/type = int
meta:/description = Number of ip addresses in this pool with base
meta:/example = 24
```

The specification above shows the use of an array specification with the `#` character.
We define the array to have a minimum value of `0` and arbitrary max length.
We use `type`, `description` and `example` as metakeys on the keys beneath each array element.

In order to get the above specification we will need following commands:

```sh
kdb meta-set spec:/sw/dockerd/default/address/pools array/min "0"

kdb meta-set spec:/sw/dockerd/default/address/pools description "Default address pools for node specific local networks (list)"

kdb meta-set spec:/sw/dockerd/default/address/pools/#/base type "string"

kdb meta-set spec:/sw/dockerd/default/address/pools/#/base description "Ip address (ipv4) + subnet"

kdb meta-set spec:/sw/dockerd/default/address/pools/#/base example "172.30.0.0/16"

kdb meta-set spec:/sw/dockerd/default/address/pools/#/size type "int"

kdb meta-set spec:/sw/dockerd/default/address/pools/#/size description "Number of ip addresses in this pool with base"

kdb meta-set spec:/sw/dockerd/default/address/pools/#/size example "24"
```

The above specification defines that we can create array elements and each can have `base` or `size`.

## Final specification code

Your specification should be complete now!
After adding all the keys that are necessary for our application, your specification should look something like this:

```ini
cat $(kdb file spec:/sw/dockerd)

# ;Ni1
# ; Generated by the ni plugin using Elektra (see libelektra.org).

[data/root]
meta:/type = string
meta:/description = Root directory of persistent Docker state
meta:/default = /var/lib/docker

[default/cgroupns/mode]
meta:/description = Default mode for containers cgroup namespace
meta:/default = private
meta:/check/enum = #1
meta:/check/enum/#0 = host
meta:/check/enum/#1 = private

[default/ulimits/_]
meta:/type = string
meta:/description = Default ulimits for containers
meta:/example = 64000

[default/address/pools]
meta:/array/min = 0
meta:/description = Default address pools for node specific local networks (list)

[default/address/pools/#/base]
meta:/type = string
meta:/description = Ip address (ipv4) + subnet
meta:/example = 172.30.0.0/16

[default/address/pools/#/size]
meta:/type = int
meta:/description = Number of ip addresses in this pool with base
meta:/example = 24
```

## Appendix (full specification)

The full specification can be viewed at [dockerd-full-spec](../../examples/spec/dockerd.ini).
